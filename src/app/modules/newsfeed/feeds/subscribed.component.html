<div class="m-newsfeed__inner">
  <ng-container [m-clientMeta]="{ source: 'feed/subscribed', medium: 'feed' }">
    <div
      class="m-border mdl-color--green mdl-color-text--white m-newsfeed-boost-promo"
      *ngIf="newUserPromo"
    >
      <i class="material-icons">trending_up</i>
      <ng-container i18n="@@MINDS__NEWSFEED__200_FREE_VIEWS"
        >Have 200 free views on us. Hit post to be boosted.
      </ng-container>
    </div>

    <ng-container>
      <m-composer
        [activity]="message ? { message: message } : undefined"
        [size]="'compact'"
        #composer
      ></m-composer>
    </ng-container>

    <m-feedNotice__outlet location="top"></m-feedNotice__outlet>

    <m-feedHeader [algorithm]="algorithm"></m-feedHeader>
    <div class="minds-list">
      <ng-container *ngIf="algorithm === 'latest'">
        <ng-container *ngFor="let preActivity of prepended; let i = index">
          <m-feedNotice__outlet
            *ngIf="i > 0 && i % 6 === 0"
            location="inline"
          ></m-feedNotice__outlet>
          <m-activity
            [entity]="preActivity"
            [displayOptions]="{
              showOnlyCommentsInput: true,
              isFeed: true
            }"
            (deleted)="delete(preActivity)"
          ></m-activity>
        </ng-container>
      </ng-container>

      <!--boost rotator-->
      <ng-container *mIfFeature="'boost-rotator'">
        <ng-container *mIfBrowser>
          <m-newsfeed--boost-rotator
            *ngIf="showBoostRotator"
            #boostRotator
          ></m-newsfeed--boost-rotator>
        </ng-container>
      </ng-container>

      <m-channelRecommendation
        location="newsfeed"
        *ngIf="
          !(isChannelRecommendationDismissed$ | async) &&
          !feedService.feedLength &&
          !feedService.inProgress
        "
      ></m-channelRecommendation>

      <!--actual feed-->
      <virtual-scroller
        #scroll
        [bufferAmount]="10"
        [items]="feed | async"
        [parentScroll]="scroll.window"
        [enableUnequalChildrenSizes]="true"
        [modifyOverflowStyleOfParentScroll]="false"
        [compareItems]="compareItems"
        [ssrChildHeight]="300"
        (vsChange)="loadNext($event)"
      >
        <m-newsfeed__activityOutlet
          *ngFor="
            let feedItem of scroll.viewPortItems;
            let i = index;
            trackBy: feedItemTrackBy
          "
        >
          <ng-container [ngSwitch]="feedItem.type">
            <ng-container *ngSwitchCase="'activity'">
              <m-activity
                *ngIf="feedItem.data.activity$ | async as activity"
                [entity]="activity"
                [displayOptions]="{
                  showOnlyCommentsInput: true,
                  isFeed: true
                }"
                [slot]="feedItem.data.slot"
                (deleted)="delete(activity)"
                #feedViewChildren
              ></m-activity>
            </ng-container>
            <div *ngSwitchCase="'feedNotice'" style="height: 1px">
              <m-feedNotice__outlet location="inline"></m-feedNotice__outlet>
            </div>
            <div *ngSwitchCase="'featuredContent'" style="height: 1px">
              <m-featured-content
                [slot]="feedItem.data.slot"
                [displayOptions]="{
                  showOnlyCommentsInput: true,
                  isFeed: true
                }"
              ></m-featured-content>
            </div>

            <div style="height: 1px" *ngSwitchCase="'topHighlights'">
              <m-topHighlights
                (onSeeMore)="onShowMoreTopFeed()"
                *ngIf="!(isTopHighlightsDismissed$ | async)"
              ></m-topHighlights>
            </div>

            <div *ngSwitchCase="'channelRecommendation'" style="height: 1px">
              <m-channelRecommendation
                location="newsfeed"
                [dismissible]="true"
                *ngIf="!(isChannelRecommendationDismissed$ | async)"
              ></m-channelRecommendation>
            </div>
          </ng-container>
        </m-newsfeed__activityOutlet>

        <!-- TODO: add loading indicator -->
        <m-loadingSpinner
          *ngIf="feedService.inProgress"
          [inProgress]="feedService.inProgress"
        ></m-loadingSpinner>
      </virtual-scroller>
    </div>
  </ng-container>
</div>

<ng-container *ngIf="algorithm === 'latest'">
  <ng-container *mIfBrowser>
    <m-seeLatestPostsButton
      [feedService]="feedService"
      (click)="scrollToUnderBoostRotator()"
    ></m-seeLatestPostsButton>
  </ng-container>
</ng-container>
